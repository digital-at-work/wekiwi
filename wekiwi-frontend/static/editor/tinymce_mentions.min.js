tinymce.PluginManager.add("mentionPlugin",(function(t){t.on("init",(function(){const e=new MutationObserver((t=>{t.forEach((t=>{t.removedNodes.forEach((t=>{if(1===t.nodeType&&t.matches&&t.matches("span[data-remind-mention]")){t.getAttribute("data-remind-mention"),t.textContent}}))}))}));e.observe(t.getBody(),{childList:!0,subtree:!0}),t.mentionObserver=e})),t.on("remove",(function(){t.mentionObserver&&t.mentionObserver.disconnect()})),t.on("keydown",(e=>{("@"===e.key||"Process"===e.key&&e.shiftKey&&"Digit2"===e.code)&&AutoComplete.getInstance(t)}))}));class AutoComplete{static instance;static isActive;static editor;static dropdown;static mentionStartIndex;id;constructor(t){this.editor=t,this.id=Math.floor(1e5*Math.random()).toString(),this.boundHandleKeydown=this.handleKeydown.bind(this),this.boundHandleKeyup=this.handleKeyup.bind(this),this.boundClearOnBlur=()=>this.clear(!0),this.bindEvents(),AutoComplete.instance=this}static getInstance(t){return this.instance||(this.instance=new AutoComplete(t)),this.instance}getId(){return this.id}bindEvents(){this.editor.on("keydown",this.boundHandleKeydown,!0),this.editor.on("keyup",this.boundHandleKeyup),this.editor.on("blur",this.boundClearOnBlur)}unbindEvents(){this.editor.off("keydown",this.boundHandleKeydown,!0),this.editor.off("keyup",this.boundHandleKeyup),this.editor.off("blur",this.boundClearOnBlur)}calcCurrentPosition(t,e){const{x:n,y:i,width:o,height:s}=this.editor.editorContainer.getBoundingClientRect(),{x:d,y:r}=t.getBoundingClientRect(),[a,h]=[200,Math.min(40*e.length+16,230)];let[c,l]=[i+r+20,n+d+10];return c+h>window.innerHeight&&(c-=h+20),l+a>window.innerWidth&&(l-=a),{top:c,left:l}}createListItem(t,e){const n=document.createElement("li");return n.className="oa-tinymce-mention-item "+(0===e?"oa-tinymce-mention-item-active":""),n.dataset.idx=e.toString(),n.dataset.userId=t.userId,n.dataset.name=t.name,n.innerText=`${t.name} - ${t.department}`,n.addEventListener("mousedown",(()=>this.selectActiveItem(n))),n}updateDropdown(t,e){this.dropdown||(this.dropdown=document.createElement("div"),this.dropdown.className="oa-tinymce-mention-container",document.body.appendChild(this.dropdown)),this.dropdown.innerHTML="",this.dropdown.style.top=`${e.top}px`,this.dropdown.style.left=`${e.left}px`;const n=document.createElement("ul");n.className="oa-tinymce-mention-list",n.dataset.size=t.length.toString(),t.forEach(((t,e)=>n.appendChild(this.createListItem(t,e)))),this.dropdown.appendChild(n)}selectActiveItem(t){const{userId:e,name:n,xuid:i}=t.dataset;if(null!=this.mentionStartIndex&&this.mentionStartIndex>=0){const t=this.editor.selection.getRng();t.setStart(t.startContainer,this.mentionStartIndex),t.deleteContents(),this.editor.execCommand("mceInsertContent",!1,`<span data-remind-mention="${this.id}" contenteditable="false" style="color: #2f68b4;">&nbsp;@${n}&nbsp;</span>`);const e=new CustomEvent("mentionSelected",{detail:{id:this.id,text:n},bubbles:!0,cancelable:!0});this.editor.getElement().dispatchEvent(e),this.clear(!0)}}highlightItem(t){if(!this.dropdown)return;const e=this.dropdown.querySelector("ul.oa-tinymce-mention-list"),n=this.dropdown.querySelector("li.oa-tinymce-mention-item-active");let i=n?Number(n.dataset.idx)+t:0;const o=Number(e.dataset.size);i<0&&(i=o-1),i>=o&&(i=0),n&&n.classList.remove("oa-tinymce-mention-item-active"),e.children[i].classList.add("oa-tinymce-mention-item-active")}handleKeydown(t){switch(t.key){case"Enter":case"Escape":t.preventDefault();break;case"ArrowUp":case"ArrowDown":case"ArrowLeft":case"ArrowRight":t.preventDefault(),"ArrowUp"===t.key&&this.highlightItem(-1),"ArrowDown"===t.key&&this.highlightItem(1)}t.stopPropagation()}handleKeyup(t){if(["Shift","Control","Alt","ArrowUp","ArrowDown"].includes(t.key))t.preventDefault();else if(["ArrowLeft","ArrowRight"].includes(t.key))this.hide();else if("Enter"===t.key){const t=this.dropdown?.querySelector("li.oa-tinymce-mention-item-active");t?this.selectActiveItem(t):this.clear()}else"Escape"===t.key?this.clear():"Delete"===t.key||this.lookup()}lookup(){const t=this.editor.selection.getRng(),e=t.startContainer.textContent||"",n=t.endOffset,i=e.lastIndexOf("@",n),o=e.slice(i+1,n).replace("\ufeff","");if(-1===i)return void this.hide();i>=0&&(this.mentionStartIndex=i);const{mentionsList:s,mentionsFilterOption:d}=this.editor.getParam("mentionOptions"),r=s.filter((t=>d?d(o,t):t.value.includes(o)));o&&r.length>0?(this.show(r,t),this.isActive=!0):this.hide()}show(t,e){const n=this.calcCurrentPosition(e,t);this.updateDropdown(t,n)}getDomValue(t){return Array.from(t.childNodes).map((t=>"#text"===t.nodeName?t.nodeValue:"SPAN"===t.nodeName?this.getDomValue(t):"")).join("")}clear(t=!1){t?Promise.resolve().then((()=>{this.unbindEvents(),this.dropdown&&document.body.removeChild(this.dropdown),this.dropdown=null})):(this.unbindEvents(),this.dropdown&&document.body.removeChild(this.dropdown),this.dropdown=null),AutoComplete.instance=void 0}hide(){this.dropdown&&document.body.contains(this.dropdown)&&(document.body.removeChild(this.dropdown),this.dropdown=null)}}